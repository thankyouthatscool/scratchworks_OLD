FROM node:18-alpine as builder
EXPOSE 5000

WORKDIR "/app"

COPY ./package.json ./
RUN npm install
COPY . .

RUN apk add openssl1.1-compat
RUN npm run db:generate
RUN npm run build

ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG DATABASE_URL
ARG NODE_ENV
ARG SECRET

ENV AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
ENV AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
ENV DATABASE_URL=$DATABASE_URL
ENV NODE_ENV=$NODE_ENV
ENV SECRET=$SECRET

CMD ["npm", "run", "start:prod"]